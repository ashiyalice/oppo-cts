# OppoCTS - Circle to Search Enabler for ColorOS

[English](README.md) | [한국어](README_ko.md) | [简体中文](README_zh.md) | [日本語](README_ja.md)

中国国内版デバイス（ColorOSなど）でデフォルトで制限されているGoogleの「かこって検索 (Circle to Search, CTS)」機能やトリガー方法が不便なデバイス向けに、**純正と99%同じユーザー体験を提供する**有効化アプリです。

## 📱 テスト済みデバイス
- **最適化デバイス**: OPPO Find X8 Ultra (中国国内版ROM / ColorOS)
- Android 14以降をベースにした他の中国メーカー国内版ROM（MIUI, HyperOS, OriginOSなど）でも同様に動作する可能性がありますが、保証はしません。

## ✨ 主な機能と特徴

### 1. 🌟 完全な下部ジェスチャーバートリガー（強く推奨）
本アプリの最も中核となる機能です。従来のShizukuやユーザー補助サービスに基づく回避策とは異なり、この機能は**Wi-Fiがオフの場合やShizukuのバックグラウンドプロセスが終了した場合でも動作します**。
- 画面下部のシステムジェスチャーバーの位置に、タッチを検出するための**目に見えない透明なオーバーレイ（表示領域）**を作成します。
- 純正の体験と同様に、**下部のバーを0.4秒間長押しするとすぐにCTSが起動します**。
- 通常のスワイプジェスチャー（ホームへのスワイプや最近のアプリの表示など）と完全に区別され、日常の使用を妨げません。
- **配置の微調整サポート**: デバイスごとに異なる下部ベゼルのサイズや解像度に合わせて、オーバーレイ領域のY軸オフセット（-100〜+100）と厚さを1ピクセル単位で調整できます。設定時には、領域を赤色で表示する**デバッグモード**もサポートしています。
- **自動非表示機能**: ナビゲーションバーが非表示の場合（フルスクリーン動画の視聴やゲーム時など）、透明なトリガー領域はシステムと動的に同期し、瞬時に自動で非表示になります。

### 2. Shizukuによる根本的な解決と権限の注入
中国版ROMの特性上、GoogleアプリはデフォルトでCTSを有効にしません。このアプリは初期設定時にShizukuの強力なADBシェル権限を利用してGoogleアプリをだまし、CTSを強制的に有効化します。
- システム設定を深く掘り下げることなく、デフォルトのデジタルアシスタント（GmsFlagSetter, AssistantSetter）の設定を自動的に処理します。
- メモリクリーンアップメカニズムによってバックグラウンドサービスが終了された場合でも、再起動後にバックグラウンドで静かに環境を復元します。

### 3. 多彩なバックアップトリガー方法
物理ボタンを好むユーザーのために、ユーザー補助サービスに基づくトリガーも提供しています。
- 音量 + / - ボタンのダブルクリックまたは長押し
- カメラのシャッターボタン

## ⚙️ 動作原理 (Technical Details)

このプロジェクトは、主に**環境初期化レイヤー**と**CTSフック/トリガーレイヤー**の2つのレイヤーで構成されています。

1. **GMSフラグ注入**:
   - Google Play開発者サービスとGoogleアプリ内には、CTSを有効にするかどうかを決定する隠しフラグ（Flags）が存在します。
   - セットアップ段階で、アプリはShizuku権限を使用して内部パッケージマネージャーの機能構成を変更し、`com.google.android.googlequicksearchbox`が現在のデバイスをサポート対象のデバイスとして認識するようにします。

2. **ネイティブサービスIntent Hook (Shizuku不要のトリガー)**:
   - ネイティブのAndroidでは、画面下部を長押しすると、システム権限で`VoiceInteractionManagerService.showSessionFromSession`または`ContextualSearchManagerService.startContextualSearch`が呼び出され、CTSが起動します。
   - このアプリは、**Android HiddenApiBypass**ライブラリを活用し、Javaのリフレクションを介してこれらの内部APIに直接アクセスします。
   - この際、システム呼び出し元（Caller）を、CTSをネイティブでサポートしているシステムパッケージ（例：`hyperOS_home`やSystem UI）に**スプーフィング（偽装）**することで、システムのセキュリティブロックを回避します。
   - その結果、最初のGMS権限注入が完了すれば、実際のポップアップアクションは完全に独立（Shizuku不要）し、Shizukuプロセスに依存することはなくなります。

3. **WindowInsetsオーバーレイマッチング**:
   - 透明なオーバーレイは、ハードコードされたサイズを使用せず、Android公式の`WindowInsetsCompat.Type.navigationBars()`APIをリアルタイムで監視します。
   - ナビゲーションバーの状態変化（横画面時にナビゲーションバーが左側/右側に移動したり、フルスクリーンモードで完全に消えたりするなど）を感知し、オーバーレイ（`WindowManager.LayoutParams.TYPE_APPLICATION_OVERLAY`）を下部のシステムジェスチャーバーと正確に同期させます。

## 🤝 クレジット (Credits)

パッケージのスプーフィングを介してネイティブシステムをトリガーする中心的なアイデア、およびバイパスパラメータ（例：flags=7, omni.entry_point=1など）は、[MiCTS](https://github.com/mizhiyong/MiCTS)プロジェクトのロジック分析から着想を得て、移植および再構築されました。

## ⚠️ 免責事項
このアプリケーションは、リフレクションを使用して隠しシステムAPIを呼び出し、サードパーティアプリケーション（Google）のフラグを変更します。
- OSのアップデート（特にGoogleアプリのアップデート）により、この機能がブロックされたり、アプリが正常に動作しなくなる可能性があります。
- このアプリの使用によって発生したデバイスの故障や無限ループ（ブートループ）などのすべてのソフトウェア上の問題についての責任は、ユーザー自身が負うものとします。
